---
import Layout from '../layouts/Layout.astro'
import PageHeader from '../components/PageHeader.astro'
import { getCollection, type CollectionEntry } from 'astro:content'

const posts = await getCollection('blog')
const sortedPosts = posts.sort((a: CollectionEntry<'blog'>, b: CollectionEntry<'blog'>) => b.data.date.getTime() - a.data.date.getTime())

// Get unique categories
const categories = [...new Set(posts.map((post: CollectionEntry<'blog'>) => post.data.category).filter(Boolean))]

const POSTS_PER_PAGE = 12
---

<Layout title="Blog" description="Actualités, conseils et informations sur les logiciels de gestion Arc Gestion.">
  <PageHeader
    title="Blog & Actualités"
    subtitle="Retrouvez nos dernières actualités, conseils et informations techniques."
    breadcrumb={[{ name: 'Blog', href: '/blog' }]}
  />

  <section class="section">
    <div class="container">
      <!-- Barre de recherche -->
      <div class="mb-6">
        <div class="max-w-xl mx-auto relative">
          <input
            type="text"
            id="search-input"
            placeholder="Rechercher un article..."
            class="w-full px-5 py-3 pl-12 rounded-full border border-gray-300 focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all"
          />
          <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
          <button id="clear-search" class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 hidden">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
      </div>

      <!-- Filtres par catégorie -->
      <div class="mb-8">
        <div class="flex flex-wrap gap-3 justify-center">
          <button class="category-filter active px-4 py-2 rounded-full bg-primary text-white font-medium transition-all" data-category="all">
            Tous ({sortedPosts.length})
          </button>
          {categories.map((category) => (
            <button class="category-filter px-4 py-2 rounded-full bg-gray-100 text-gray-700 font-medium hover:bg-primary hover:text-white transition-all" data-category={category}>
              {category} ({posts.filter((p: CollectionEntry<'blog'>) => p.data.category === category).length})
            </button>
          ))}
        </div>
      </div>

      <!-- Résultats de recherche -->
      <div id="search-results" class="mb-4 text-center text-gray-600 hidden"></div>

      <!-- Grille des articles -->
      <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8 mb-8" id="posts-grid">
        {sortedPosts.map((post: CollectionEntry<'blog'>, index: number) => (
          <article
            class="bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition-shadow post-card"
            data-category={post.data.category || 'Non catégorisé'}
            data-title={post.data.title.toLowerCase()}
            data-excerpt={post.data.excerpt?.toLowerCase() || ''}
            data-index={index}
            style={index >= POSTS_PER_PAGE ? 'display: none;' : ''}
          >
            <div class="p-6">
              <div class="flex items-center justify-between mb-2">
                <p class="text-sm text-gray-500">
                  {post.data.date.toLocaleDateString('fr-FR', { year: 'numeric', month: 'long', day: 'numeric' })}
                </p>
                {post.data.category && (
                  <span class="text-xs bg-secondary/10 text-secondary px-2 py-1 rounded font-medium">
                    {post.data.category}
                  </span>
                )}
              </div>
              <h2 class="text-xl font-bold text-gray-800 mb-3">
                <a href={`/blog/${post.slug}`} class="hover:text-primary transition-colors">
                  {post.data.title}
                </a>
              </h2>
              <p class="text-gray-600 mb-4 line-clamp-3">{post.data.excerpt}</p>
              <a href={`/blog/${post.slug}`} class="text-primary font-semibold hover:underline">
                Lire la suite →
              </a>
            </div>
          </article>
        ))}
      </div>

      <!-- Pagination -->
      <div id="pagination" class="flex justify-center items-center gap-2 mb-12">
        <button id="prev-page" class="px-4 py-2 rounded-lg bg-gray-100 text-gray-700 hover:bg-primary hover:text-white transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled>
          ← Précédent
        </button>
        <div id="page-numbers" class="flex gap-1"></div>
        <button id="next-page" class="px-4 py-2 rounded-lg bg-gray-100 text-gray-700 hover:bg-primary hover:text-white transition-all disabled:opacity-50 disabled:cursor-not-allowed">
          Suivant →
        </button>
      </div>

      <!-- Liens vers les autres blogs -->
      <div class="bg-gray-50 rounded-2xl p-8 md:p-12">
        <h2 class="text-2xl font-extrabold text-gray-800 mb-6 text-center">Nos autres ressources</h2>
        <div class="grid md:grid-cols-2 gap-6">
          <a href="https://blog.arcgestion.fr" target="_blank" rel="noopener" class="bg-white rounded-xl p-6 shadow-lg hover:shadow-xl transition-shadow">
            <h3 class="font-bold text-primary mb-2">Blog Tech' Arc Gestion</h3>
            <p class="text-gray-600 text-sm">Trucs et astuces techniques sur les logiciels Sage et Codial.</p>
          </a>
          <a href="https://www.assistance-api.fr/index.php/forum/index" target="_blank" rel="noopener" class="bg-white rounded-xl p-6 shadow-lg hover:shadow-xl transition-shadow">
            <h3 class="font-bold text-primary mb-2">Forum d'entraide</h3>
            <p class="text-gray-600 text-sm">Posez vos questions et échangez avec la communauté.</p>
          </a>
        </div>
      </div>
    </div>
  </section>
</Layout>

<script define:vars={{ POSTS_PER_PAGE }}>
  document.addEventListener('DOMContentLoaded', () => {
    const filterButtons = document.querySelectorAll('.category-filter');
    const postCards = document.querySelectorAll('.post-card');
    const searchInput = document.getElementById('search-input');
    const clearSearch = document.getElementById('clear-search');
    const searchResults = document.getElementById('search-results');
    const prevBtn = document.getElementById('prev-page');
    const nextBtn = document.getElementById('next-page');
    const pageNumbers = document.getElementById('page-numbers');

    let currentPage = 1;
    let currentCategory = 'all';
    let searchQuery = '';
    let filteredCards = Array.from(postCards);

    function getVisibleCards() {
      return Array.from(postCards).filter(card => {
        const category = card.getAttribute('data-category');
        const title = card.getAttribute('data-title') || '';
        const excerpt = card.getAttribute('data-excerpt') || '';

        const matchesCategory = currentCategory === 'all' || category === currentCategory;
        const matchesSearch = searchQuery === '' ||
          title.includes(searchQuery.toLowerCase()) ||
          excerpt.includes(searchQuery.toLowerCase());

        return matchesCategory && matchesSearch;
      });
    }

    function updateDisplay() {
      filteredCards = getVisibleCards();
      const totalPages = Math.ceil(filteredCards.length / POSTS_PER_PAGE);

      // Reset to page 1 if current page exceeds total
      if (currentPage > totalPages) currentPage = 1;

      const startIndex = (currentPage - 1) * POSTS_PER_PAGE;
      const endIndex = startIndex + POSTS_PER_PAGE;

      // Hide all cards first
      postCards.forEach(card => {
        card.style.display = 'none';
      });

      // Show only filtered cards for current page
      filteredCards.forEach((card, index) => {
        if (index >= startIndex && index < endIndex) {
          card.style.display = 'block';
        }
      });

      // Update search results text
      if (searchQuery || currentCategory !== 'all') {
        searchResults.textContent = `${filteredCards.length} article${filteredCards.length > 1 ? 's' : ''} trouvé${filteredCards.length > 1 ? 's' : ''}`;
        searchResults.classList.remove('hidden');
      } else {
        searchResults.classList.add('hidden');
      }

      // Update pagination
      updatePagination(totalPages);
    }

    function updatePagination(totalPages) {
      // Update buttons state
      prevBtn.disabled = currentPage === 1;
      nextBtn.disabled = currentPage === totalPages || totalPages === 0;

      // Generate page numbers
      pageNumbers.innerHTML = '';

      if (totalPages <= 7) {
        for (let i = 1; i <= totalPages; i++) {
          addPageButton(i);
        }
      } else {
        // Show first page
        addPageButton(1);

        if (currentPage > 3) {
          const ellipsis = document.createElement('span');
          ellipsis.textContent = '...';
          ellipsis.className = 'px-2 text-gray-500';
          pageNumbers.appendChild(ellipsis);
        }

        // Show pages around current
        for (let i = Math.max(2, currentPage - 1); i <= Math.min(totalPages - 1, currentPage + 1); i++) {
          addPageButton(i);
        }

        if (currentPage < totalPages - 2) {
          const ellipsis = document.createElement('span');
          ellipsis.textContent = '...';
          ellipsis.className = 'px-2 text-gray-500';
          pageNumbers.appendChild(ellipsis);
        }

        // Show last page
        if (totalPages > 1) addPageButton(totalPages);
      }
    }

    function addPageButton(pageNum) {
      const btn = document.createElement('button');
      btn.textContent = pageNum.toString();
      btn.className = pageNum === currentPage
        ? 'w-10 h-10 rounded-lg bg-primary text-white font-medium'
        : 'w-10 h-10 rounded-lg bg-gray-100 text-gray-700 hover:bg-primary hover:text-white transition-all';
      btn.addEventListener('click', () => {
        currentPage = pageNum;
        updateDisplay();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });
      pageNumbers.appendChild(btn);
    }

    // Category filter
    filterButtons.forEach(button => {
      button.addEventListener('click', () => {
        currentCategory = button.getAttribute('data-category') || 'all';
        currentPage = 1;

        // Update active button
        filterButtons.forEach(btn => {
          btn.classList.remove('active', 'bg-primary', 'text-white');
          btn.classList.add('bg-gray-100', 'text-gray-700');
        });
        button.classList.add('active', 'bg-primary', 'text-white');
        button.classList.remove('bg-gray-100', 'text-gray-700');

        updateDisplay();
      });
    });

    // Search functionality
    searchInput.addEventListener('input', (e) => {
      searchQuery = e.target.value;
      currentPage = 1;
      clearSearch.classList.toggle('hidden', searchQuery === '');
      updateDisplay();
    });

    clearSearch.addEventListener('click', () => {
      searchInput.value = '';
      searchQuery = '';
      currentPage = 1;
      clearSearch.classList.add('hidden');
      updateDisplay();
    });

    // Pagination buttons
    prevBtn.addEventListener('click', () => {
      if (currentPage > 1) {
        currentPage--;
        updateDisplay();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    });

    nextBtn.addEventListener('click', () => {
      const totalPages = Math.ceil(filteredCards.length / POSTS_PER_PAGE);
      if (currentPage < totalPages) {
        currentPage++;
        updateDisplay();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    });

    // Initial display
    updateDisplay();
  });
</script>

<style>
  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
